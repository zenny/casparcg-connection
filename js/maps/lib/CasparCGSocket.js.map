{"version":3,"sources":["lib/CasparCGSocket.ts"],"names":[],"mappings":"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","file":"lib/CasparCGSocket.js","sourcesContent":["import * as net from \"net\";\nimport * as _ from \"highland\";\nimport {EventEmitter} from \"hap\";\nimport {IConnectionOptions, ConnectionOptions} from \"./AMCPConnectionOptions\";\nimport {AMCPUtil} from \"./AMCP\";\n// Command NS\nimport {Command as CommandNS} from \"./AbstractCommand\";\nimport IAMCPCommand = CommandNS.IAMCPCommand;\nimport IAMCPResponse = CommandNS.IAMCPResponse;\nimport AMCPResponse = CommandNS.AMCPResponse;\nimport IAMCPStatus = CommandNS.IAMCPStatus;\n// Event NS\nimport {CasparCGSocketStatusEvent, CasparCGSocketCommandEvent, CasparCGSocketResponseEvent} from \"./event/Events\";\n// Callback NSIAMCPResponse\nimport {Callback as CallbackNS} from \"./global/Callback\";\nimport IResponseCallback = CallbackNS.IResponseCallback;\n// Param NS \nimport {Param as ParamNS} from \"./ParamSignature\";\nimport Payload = ParamNS.Payload;\n\n/**\n * \n */\nexport interface ICasparCGSocket {\n\tconnected: boolean;\n\thost: string;\n\tport: number;\n\tsocketStatus: SocketState;\n\tconnect(): void;\n\tdisconnect(): void;\n\tdispose(): void;\n\tlog(args: any): void;\n\texecuteCommand(command: IAMCPCommand): IAMCPCommand;\n}\n\nexport enum SocketState {\n\t\tunconfigured\t= 0,\n\t\tconfigured\t\t= 1 << 0,\n\t\thostFound\t\t= 1 << 1,\t\t// @todo: implement\n\t\tconnectionAttempt = 1 << 2,\t\t// @todo: implement\n\t\tconnected\t\t= 1 << 3,\n\t\tdisconnected\t= 1\t<< 4,\n\t\tlostConnection\t= 1 << 5,\n\t\treconnecting\t= 1 << 6\n}\n\n/**\n * \n */\nexport class CasparCGSocket extends EventEmitter implements ICasparCGSocket {\n\tprivate _client: net.Socket;\n\n\tprivate _host: string;\n\tprivate _port: number;\n\tprivate _autoReconnect: boolean;\n\tprivate _reconnectDelay: number;\n\tprivate _reconnectAttempts: number;\n\tprivate _reconnectAttempt: number = 0;\n\tprivate _reconnectInterval: NodeJS.Timer;\n\tprivate _commandTimeoutTimer: NodeJS.Timer;\n\tprivate _commandTimeout: number = 5000; // @todo make connectionOption!\n\tprivate _socketStatus: SocketState = SocketState.unconfigured;\n\n\tprivate _parsedResponse: AMCPUtil.CasparCGSocketResponse;\n\n\t/**\n\t * \n\t */\n\tpublic constructor(host: string, port: number, autoReconnect: boolean, autoReconnectInterval: number, autoReconnectAttempts: number) {\n\t\tsuper();\n\t\tthis._host = host;\n\t\tthis._port = port;\n\t\tthis._reconnectDelay = autoReconnectInterval;\n\t\tthis._autoReconnect = autoReconnect;\n\t\tthis._reconnectAttempts = autoReconnectAttempts;\n\t\tthis._client = new net.Socket();\n\t\tthis._client.on(\"lookup\", () => this._onLookup());\n\t\tthis._client.on(\"connect\", () => this._onConnected());\n\t\tthis._client.on(\"error\", (error: Error) => this._onError(error));\n\t\tthis._client.on(\"drain\", () => this._onDrain());\n\t\tthis._client.on(\"close\", (hadError: boolean) => this._onClose(hadError));\n\n\t\t_(this._client)[\"splitBy\"](/(?=\\r\\n)/).errors((error) => this._onError(error)).each((i) => this._parseResponseGroups(i));\t// @todo: [\"splitBy] hack due to missing type\n\t\tthis.socketStatus = SocketState.configured;\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic set autoReconnect(autoReconnect: boolean) {\n\t\tthis._autoReconnect = autoReconnect;\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic set autoReconnectInterval(autoReconnectInterval: number) {\n\t\tthis._reconnectDelay = autoReconnectInterval;\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic set autoReconnectAttempts(autoReconnectAttempts: number) {\n\t\tthis._reconnectAttempts = autoReconnectAttempts;\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic connect(): void {\n\t\tthis.socketStatus |= SocketState.connectionAttempt;\t// toggles triedConnection on\n\t\tthis.socketStatus &= ~SocketState.lostConnection;\t// toggles triedConnection on\n\t\tthis._client.connect(this._port, this._host);\n\t\tif (this._reconnectAttempt === 0) {\n\t\t\tthis._reconnectInterval = global.setInterval(() => this._autoReconnection(), this._reconnectDelay);\n\t\t}\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic disconnect(): void {\n\t\tif (this._client !== undefined) {\n\t\t\tthis.dispose();\n\t\t}\n\t}\n\n\t/**\n\t * \n\t */\n\tprivate _startReconnection(): void {\n\t\t// create interval if doesn't exist\n\t\tif (!this._reconnectInterval) {\n\t\t\t// @todo: create event telling reconection is in action with interval time\n\t\t\tthis.socketStatus |= SocketState.reconnecting;\n\t\t\tthis._reconnectInterval = global.setInterval(() => this._autoReconnection(), this._reconnectDelay);\n\t\t}\n\t}\n\n\t/**\n\t * \n\t */\n\tprivate _autoReconnection(): void {\n\t\tif (this._autoReconnect) {\n\t\t\tif (this._reconnectAttempts > 0) {\t\t\t\t\t\t\t\t// no reconnection if no valid reconnectionAttemps is set\n\t\t\t\tif ((this._reconnectAttempt >= this._reconnectAttempts)) {\t// if current attempt is not less than max attempts\n\t\t\t\t\t// reset reconnection behaviour\n\t\t\t\t\tthis._clearReconnectInterval();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t// new attempt\n\t\t\tthis.log(\"Socket attempting reconnection\");\n\t\t\tthis._reconnectAttempt++;\n\t\t\tthis.connect();\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * \n\t */\n\tprivate _clearReconnectInterval(): void {\n\t\t// @todo create event telling reconnection ended with result: true/false\n\t\t// only in reconnectio intervall is true\n\t\tthis._reconnectAttempt = 0;\n\t\tglobal.clearInterval(this._reconnectInterval);\n\t\tthis.socketStatus &= ~SocketState.reconnecting;\n\t\tdelete this._reconnectInterval;\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic get host(): string{\n\t\tif (this._client) {\n\t\t\treturn this._host;\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic get port(): number{\n\t\tif (this._client) {\n\t\t\treturn this._port;\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic get socketStatus(): SocketState{\n\t\treturn this._socketStatus;\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic set socketStatus(statusMask: SocketState){\n\t\tif (this._socketStatus !== statusMask) {\n\t\t\tthis._socketStatus = statusMask;\n\t\t\tthis.fire(CasparCGSocketStatusEvent.STATUS, new CasparCGSocketStatusEvent(this._socketStatus));\n\t\t}\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic dispose(): void {\n\t\tthis._clearReconnectInterval();\n\t\tthis._client.destroy();\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic log(args: any): void {\n\t\t// fallback, this method will be remapped to CasparCG.log by CasparCG on instantiation of socket oject\n\t\tconsole.log(args);\n\t}\n\n\t/**\n\t */\n\tset connected(connected: boolean){\n\t\tthis.socketStatus = connected ? this.socketStatus | SocketState.connected : this.socketStatus &= ~SocketState.connected;\n\t}\n\n\t/**\n\t * \n\t */\n\tpublic executeCommand(command: IAMCPCommand): IAMCPCommand {\n\t\tlet commandString: string = command.constructor[\"commandString\"] + (command.address ? \" \" + command.address : \"\");\n\t\tfor (let i in command.payload) {\n\t\t\tlet payload: Payload = command.payload[i];\n\t\t\tcommandString += (commandString.length > 0 ? \" \" : \"\");\n\t\t\tcommandString += (payload.key ? payload.key + \" \" : \"\") + payload.value;\n\t\t}\n\n\t\tthis._commandTimeoutTimer = global.setTimeout(() => this._onTimeout(), this._commandTimeout);\n\t\tthis._client.write(`${commandString}\\r\\n`);\n\t\tcommand.status = IAMCPStatus.Sent;\n\n\t\tthis.log(commandString);\n\t\treturn command;\n\t}\n\n\t/** \n\t * \n\t */\n\tprivate _onTimeout() {\n\t\tglobal.clearTimeout(this._commandTimeoutTimer);\n\t\tthis.fire(CasparCGSocketStatusEvent.TIMEOUT, new CasparCGSocketStatusEvent(this.socketStatus));\n\t}\n\n\t/**\n\t * @todo:::\n\t */\n\tprivate _onLookup() {\n\t\tthis.log(\"Socket event lookup\");\n\t}\n\n\t/**\n\t * \n\t */\n\tprivate _onConnected() {\n\t\tthis._clearReconnectInterval();\n\t\tthis.connected = true;\n\t}\n\n\t/**\n\t * \n\t */\n\tprivate _parseResponseGroups(i: string): void {\n\t\tglobal.clearTimeout(this._commandTimeoutTimer);\n\t\ti = (i.length > 2 && i.slice(0, 2) === \"\\r\\n\") ? i.slice(2) : i;\n\t\tif (AMCPUtil.CasparCGSocketResponse.evaluateStatusCode(i) === 200) {\n\t\t\tthis._parsedResponse = new AMCPUtil.CasparCGSocketResponse(i);\n\t\t\treturn;\n\t\t} else if (this._parsedResponse && this._parsedResponse.statusCode === 200) {\n\t\t\tif (i !== \"\\r\\n\") {\n\t\t\t\tthis._parsedResponse.items.push(i);\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\tthis.fire(CasparCGSocketResponseEvent.RESPONSE, new CasparCGSocketResponseEvent(this._parsedResponse));\n\t\t\t\tthis._parsedResponse = null;\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tif (AMCPUtil.CasparCGSocketResponse.evaluateStatusCode(i) === 201 || AMCPUtil.CasparCGSocketResponse.evaluateStatusCode(i) === 400 || AMCPUtil.CasparCGSocketResponse.evaluateStatusCode(i) === 101) {\n\t\t\tthis._parsedResponse = new AMCPUtil.CasparCGSocketResponse(i);\n\t\t\treturn;\n\t\t} else if (this._parsedResponse && this._parsedResponse.statusCode === 201 || this._parsedResponse && this._parsedResponse.statusCode === 400 || this._parsedResponse && this._parsedResponse.statusCode === 101) {\n\t\t\tthis._parsedResponse.items.push(i);\n\t\t\tthis.fire(CasparCGSocketResponseEvent.RESPONSE, new CasparCGSocketResponseEvent(this._parsedResponse));\n\t\t\tthis._parsedResponse = null;\n\t\t\treturn;\n\t\t} else {\n\t\t\tthis.fire(CasparCGSocketResponseEvent.RESPONSE, new CasparCGSocketResponseEvent(new AMCPUtil.CasparCGSocketResponse(i)));\n\t\t\treturn;\n\t\t}\n\t}\n\n\t/**\n\t * @todo:::\n\t */\n\tprivate _onError(error: Error) {\n\t\t// dispatch error!!!!!\n\t\tthis.log(`Socket event error: ${error.message}`);\n\t}\n\n\t/**\n\t * @todo:::\n\t */\n\tprivate _onDrain() {\n\t\t// @todo: implement\n\t\tthis.log(\"Socket event drain\");\n\t}\n\n\t/**\n\t * \n\t */\n\tprivate _onClose(hadError: boolean) {\n\t\tthis.connected = false;\n\t\tif (hadError) {\n\t\t\tthis.socketStatus |= SocketState.lostConnection;\n\t\t\t// error message, not \"log\"\n\t\t\t// dispatch (is it done through error handler first????)\n\t\t\tthis.log(`Socket close with error: ${hadError}`);\n\t\t\tif (this._autoReconnect) {\n\t\t\t\tthis._startReconnection();\n\t\t\t}\n\t\t}else {\n\t\t\tthis._clearReconnectInterval();\n\t\t}\n\t}\n} "],"sourceRoot":"/source/"}